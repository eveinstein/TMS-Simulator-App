# MT Training Bug Fix Summary

## Issue
Users could achieve "A" grades in Motor Threshold Training mode even when the coil was visually far from the revealed hotspot. This should be impossible if the distance penalty is working correctly.

## Root Cause Analysis

### Bug 1: Hotspot Not Projected to Scalp Surface (CRITICAL)
**Location:** `tmsStore.js`, `generateHotspotPosition()` function

**Problem:** The hotspot was generated by offsetting C3's X and Z coordinates while keeping the Y coordinate constant:
```javascript
// OLD BROKEN CODE
return [
  c3Position[0] + r * Math.cos(angle),
  c3Position[1], // Same Y as C3 - WRONG!
  c3Position[2] + r * Math.sin(angle),
];
```

For a dome-shaped head, moving in XZ while keeping Y constant puts the hotspot **inside** or **outside** the head, not on the scalp surface. This caused the distance calculation to be geometrically incorrect.

### Bug 2: UI Buttons Used Stale/Zero Distance (CRITICAL)
**Location:** `RMTPanel.jsx`, `handleFirePulse()` and `handleRunTenPulse()` functions

**Problem:** The UI buttons used cached distance from the previous pulse:
```javascript
// OLD BROKEN CODE
const handleFirePulse = useCallback(() => {
  const distance = rmt.distanceToHotspot || 0;  // First pulse: null → 0!
  firePulse(distance);
}, [firePulse, rmt.distanceToHotspot]);
```

On the first pulse, `rmt.distanceToHotspot` was null, so it defaulted to 0. This meant **zero distance penalty** regardless of actual coil position!

### Combined Effect
1. User starts trial → hotspot generated off-surface (geometrically wrong position)
2. User clicks "Fire Pulse" button → distance = 0 (stale/default)
3. Penalty = 0 → apparentMT = trueMT
4. High twitch probability regardless of coil location
5. User achieves 5/10 easily → gets "A" grade
6. Reveals hotspot → appears far away (because it was generated incorrectly)

## Fixes Implemented

### Fix 1: Surface-Projected Hotspot
**Files changed:** `tmsStore.js`, `TMSCoil.jsx`

The hotspot is now generated as an "offset target" but immediately projected onto the actual scalp surface using raycasting:

```javascript
// In TMSCoil.jsx frame loop
if (mode === 'rmt' && rmt.hotspotPosition && scalpSurfaceRef.current) {
  const targetPos = new THREE.Vector3(...rmt.hotspotPosition);
  const surfaceResult = scalpSurfaceRef.current.findSurfacePoint(targetPos);
  
  if (surfaceResult) {
    const projected = [surfaceResult.point.x, surfaceResult.point.y, surfaceResult.point.z];
    setHotspotPosition(projected);
  }
}
```

### Fix 2: Real-Time Distance Computation
**Files changed:** `tmsStore.js`, `RMTPanel.jsx`, `TMSCoil.jsx`

All pulse triggers now compute fresh distance at fire time:

```javascript
// In tmsStore.js - new function
getCurrentDistanceMm: () => {
  const { rmt, currentCoilWorldPos } = get();
  if (!rmt.hotspotPosition || !currentCoilWorldPos) return 0;
  
  const dx = currentCoilWorldPos[0] - rmt.hotspotPosition[0];
  const dy = currentCoilWorldPos[1] - rmt.hotspotPosition[1];
  const dz = currentCoilWorldPos[2] - rmt.hotspotPosition[2];
  return Math.sqrt(dx*dx + dy*dy + dz*dz) * 1000; // mm
}

// In RMTPanel.jsx - FIXED
const handleFirePulse = useCallback(() => {
  const distance = getCurrentDistanceMm();  // Fresh distance!
  firePulse(distance);
}, [firePulse, getCurrentDistanceMm]);
```

### Fix 3: Coil Position Tracking
**Files changed:** `tmsStore.js`, `TMSCoil.jsx`

The coil's world position is now updated every frame in the store:

```javascript
// In TMSCoil.jsx frame loop
setCurrentCoilWorldPos([pos.x, pos.y, pos.z]);
```

This allows the store's `getCurrentDistanceMm()` function to compute accurate real-time distance.

### Fix 4: Dev Debug Overlay
**New file:** `MTDebugOverlay.jsx`

A development-only overlay that shows all critical values in real-time:
- True MT
- Current intensity
- Coil position (world)
- Hotspot position (world)
- Distance (mm)
- Penalty
- Apparent MT
- Probability
- Last pulse random draw and result
- Titration stats

## Verification

### Automated Tests
All tests pass:
```
node --experimental-vm-modules src/engine/__tests__/mtTraining.test.js
✓ All tests passed! (22/22)

node --experimental-vm-modules src/engine/__tests__/mtTrainingValidation.test.js
✓ All validation tests passed!
```

### Key Validation Points

1. **At hotspot (d=0):** penalty=0%, at I=trueMT: p≈50%
2. **At d=30mm:** penalty≈17%, at I=trueMT: p≈0.02% (almost no twitches)
3. **At d=30mm with compensated intensity:** At I=apparentMT≈67%: p≈50%

### Manual Testing Checklist

1. Start MT Training mode
2. Observe the debug overlay (dev mode only)
3. Move coil FAR from C3
4. Fire pulses - should see:
   - Distance > 20mm
   - Penalty > 10%
   - Probability < 10%
   - Almost no twitches
5. Move coil close to C3
6. Fire pulses - should see:
   - Distance < 5mm
   - Penalty < 2%
   - Probability ≈ 50% at I=trueMT
7. Confirm you CANNOT get "A" grade when visibly far from hotspot
   (unless you happen to guess trueMT exactly, which is rare)

## Files Changed

1. `src/stores/tmsStore.js`
   - Renamed `generateHotspotPosition` → `generateHotspotOffset`
   - Added `currentCoilWorldPos` state
   - Added `setCurrentCoilWorldPos()` action
   - Added `setHotspotPosition()` action
   - Added `getCurrentDistanceMm()` selector
   - Added `debugData` to RMT state
   - Updated `firePulse()` to include debug data

2. `src/components/scene/TMSCoil.jsx`
   - Added hotspot surface projection in frame loop
   - Added coil world position update in frame loop
   - Updated spacebar handler to use `getCurrentDistanceMm()`

3. `src/components/ui/RMTPanel.jsx`
   - Updated `handleFirePulse` to use `getCurrentDistanceMm()`
   - Updated `handleRunTenPulse` to use `getCurrentDistanceMm()`
   - Updated `handleComplete` to use `getCurrentDistanceMm()`
   - Updated "Submit current intensity" button to use `getCurrentDistanceMm()`

4. `src/components/ui/MTDebugOverlay.jsx` (NEW)
   - Dev-only debug overlay component

5. `src/App.jsx`
   - Added MTDebugOverlay import and render

6. `src/engine/__tests__/mtTrainingValidation.test.js` (NEW)
   - Comprehensive validation test suite

## Non-Negotiable Behavior (Verified)

✅ Being farther from hotspot raises apparentMT and reduces twitch probability
✅ At true hotspot with I=trueMT: p≈50%
✅ Off-hotspot at same intensity: p drops sharply
✅ User needs higher intensity off-hotspot to regain 5/10
✅ Grade is based on userMT vs trueMT (NOT apparentMT)
✅ Hotspot for sampling = hotspot for reveal visualization
